rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // üîß HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check for admin custom claim
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // Check if user owns the memorial (creator or createdBy)
    function isOwner(memorialId) {
      return request.auth != null && (
        request.auth.uid == get(/databases/$(database)/documents/memorials/$(memorialId)).data.creatorUid ||
        request.auth.uid == get(/databases/$(database)/documents/memorials/$(memorialId)).data.createdByUserId
      );
    }
    
    // Check if user is a family member of the memorial
    function isFamilyMember(memorialId) {
      return request.auth != null && 
        exists(/databases/$(database)/documents/memorials/$(memorialId)/familyMembers/$(request.auth.uid));
    }
    
    // Combined check for edit permissions
    function canEditMemorial(memorialId) {
      return isAdmin() || isOwner(memorialId) || isFamilyMember(memorialId);
    }
    
    // Check if only updating allowed photo fields
    function onlyUpdatingPhotoFields() {
      let changedFields = request.resource.data.diff(resource.data).affectedKeys();
      // Allow updates to photos, photoMetadata, and updatedAt fields
      return changedFields.hasOnly(['photos', 'photoMetadata', 'updatedAt']);
    }
    
    // Check if memorial is public
    function isPublicMemorial() {
      return resource.data.isPublic == true;
    }
    
    // ============================================
    // üë• USER DOCUMENTS
    // ============================================
    
    match /users/{userId} {
      // Admins can read/write any user document
      // Regular users can only read/write their own
      allow read, write: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
    }
    
    // ============================================
    // üïØÔ∏è MEMORIAL DOCUMENTS
    // ============================================
    
    match /memorials/{memorialId} {
      // Read access: public memorials, owners, family members, admins, or checking existence for URL availability
      allow read: if isPublicMemorial() || canEditMemorial(memorialId) || 
        // Allow unauthenticated reads for URL availability checking (will return false for non-existent docs)
        request.auth == null;
      
      // Create: any authenticated user can create a memorial
      allow create: if isSignedIn();
      
      // Update: differentiated by user role
      allow update: if canEditMemorial(memorialId) && (
        // Owners and admins can update anything
        isAdmin() || isOwner(memorialId) ||
        // Family members can only update photo-related fields
        (isFamilyMember(memorialId) && onlyUpdatingPhotoFields())
      );
      
      // Delete: only owners and admins
      allow delete: if isAdmin() || isOwner(memorialId);
      
      // ============================================
      // üë®‚Äçüë©‚Äçüëß‚Äçüë¶ FAMILY MEMBERS SUBCOLLECTION
      // ============================================
      
      match /familyMembers/{userId} {
        // Read: owners, admins, and the family member themselves
        allow read: if canEditMemorial(memorialId) || request.auth.uid == userId;
        
        // Write: only owners and admins can add/remove family members
        allow create, update, delete: if isOwner(memorialId) || isAdmin();
      }
      
      // ============================================
      // üë• FOLLOWERS SUBCOLLECTION
      // ============================================
      
      match /followers/{userId} {
        // Users can only manage their own follow status
        allow read, create, delete: if isSignedIn() && request.auth.uid == userId;
        // No updates allowed once following
        allow update: if false;
      }
    }
    
    // ============================================
    // ‚úâÔ∏è INVITATION DOCUMENTS
    // ============================================
    
    match /invitations/{invitationId} {
      // Read access: admins, sender, or recipient
      allow read: if isAdmin() ||
        (isSignedIn() && request.auth.uid == resource.data.invitedByUid) ||
        (isSignedIn() && request.auth.token.email == resource.data.inviteeEmail);
      
      // Create: only memorial owners can send invitations
      allow create: if isSignedIn() && 
        request.auth.uid == request.resource.data.invitedByUid &&
        isOwner(request.resource.data.memorialId);
      
      // Update: only recipients can accept invitations
      allow update: if isSignedIn() && 
        request.auth.token.email == resource.data.inviteeEmail &&
        request.resource.data.status == 'accepted' &&
        // Ensure only status and acceptedAt fields are being updated
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'acceptedAt']);
      
      // Delete: disabled for security (maintain audit trail)
      allow delete: if false;
    }
    
    // ============================================
    // üìä LIVESTREAM CONFIGURATIONS
    // ============================================
    
    match /livestreamConfigurations/{configId} {
      // Read: public for memorials that are public, otherwise restricted
      allow read: if isAdmin() || 
        (resource.data.memorialId != null && 
          (get(/databases/$(database)/documents/memorials/$(resource.data.memorialId)).data.isPublic == true ||
           canEditMemorial(resource.data.memorialId)));
      
      // Write: only owners and admins
      allow create, update: if isSignedIn() && 
        (isAdmin() || isOwner(request.resource.data.memorialId));
      
      allow delete: if isAdmin() || 
        (resource.data.memorialId != null && isOwner(resource.data.memorialId));
    }
    
    // ============================================
    // üì∏ PHOTO UPLOAD LOGS
    // ============================================
    
    match /photoUploads/{uploadId} {
      // Read: admins and memorial editors
      allow read: if isAdmin() || 
        (resource.data.memorialId != null && canEditMemorial(resource.data.memorialId));
      
      // Create: handled by server-side functions only
      allow create: if false;
      
      // No updates or deletes allowed (audit trail)
      allow update, delete: if false;
    }
    
    // ============================================
    // üìà ANALYTICS (read-only for clients)
    // ============================================
    
    match /analytics/{docId} {
      allow read: if isAdmin();
      allow write: if false; // Server-side only
    }
    
    // ============================================
    // üîç AUDIT LOGS (read-only for clients)
    // ============================================
    
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Server-side only
    }
  }
}